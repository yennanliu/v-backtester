<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STRATAGEM — MA Backtester</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=JetBrains+Mono:ital,wght@0,300;0,400;0,500;0,700;1,400&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        /* ─────────────────────────────────────────
           RESET & TOKENS
        ───────────────────────────────────────── */
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --void:          #030810;
            --surface:       #060e18;
            --panel:         #091525;
            --elevated:      #0d1d2e;
            --border:        #0f2035;
            --border-hi:     #183348;
            --accent:        #05f5b0;
            --accent-glow:   rgba(5, 245, 176, 0.15);
            --accent-faint:  rgba(5, 245, 176, 0.05);
            --buy:           #05f5b0;
            --buy-glow:      rgba(5, 245, 176, 0.25);
            --sell:          #ff3f5c;
            --sell-glow:     rgba(255, 63, 92, 0.25);
            --warn:          #ffb83f;
            --text:          #b8d0e4;
            --text-muted:    #3f6080;
            --text-dim:      #1a3050;
            --font-ui:       'Syne', sans-serif;
            --font-data:     'JetBrains Mono', monospace;
            --r:             4px;
        }

        html, body {
            height: 100%;
            background: var(--void);
            color: var(--text);
            font-family: var(--font-ui);
            font-size: 16px;
            line-height: 1.5;
            overflow: hidden;
        }

        /* dot-grid atmosphere */
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background-image: radial-gradient(circle, rgba(5,245,176,0.055) 1px, transparent 1px);
            background-size: 28px 28px;
            pointer-events: none;
            z-index: 0;
        }

        /* vignette */
        body::after {
            content: '';
            position: fixed;
            inset: 0;
            background: radial-gradient(ellipse at center, transparent 40%, rgba(3,8,16,0.7) 100%);
            pointer-events: none;
            z-index: 0;
        }

        /* ─────────────────────────────────────────
           HEADER
        ───────────────────────────────────────── */
        .hdr {
            position: relative;
            z-index: 20;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 32px;
            height: 54px;
            background: rgba(6,14,24,0.95);
            border-bottom: 1px solid var(--border-hi);
            backdrop-filter: blur(8px);
            overflow: hidden;
        }

        /* shimmer sweep */
        .hdr::after {
            content: '';
            position: absolute;
            top: 0; left: -100%;
            width: 50%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(5,245,176,0.04), transparent);
            animation: hdr-sweep 5s linear infinite;
        }
        @keyframes hdr-sweep { to { left: 200%; } }

        .hdr-left { display: flex; align-items: center; gap: 18px; }

        .logo {
            font-family: var(--font-ui);
            font-size: 20px;
            font-weight: 800;
            letter-spacing: 0.18em;
            color: var(--accent);
            text-shadow: 0 0 22px var(--buy-glow);
            animation: fade-in 0.6s ease both;
        }

        .hdr-div {
            width: 1px;
            height: 22px;
            background: var(--border-hi);
        }

        .hdr-sub {
            font-family: var(--font-data);
            font-size: 13px;
            font-weight: 400;
            color: var(--text-muted);
            letter-spacing: 0.12em;
            text-transform: uppercase;
            animation: fade-in 0.6s ease 0.1s both;
        }

        .hdr-right {
            display: flex;
            align-items: center;
            gap: 10px;
            font-family: var(--font-data);
            font-size: 12px;
            color: var(--text-muted);
            letter-spacing: 0.1em;
            animation: fade-in 0.6s ease 0.15s both;
        }

        .live-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--buy);
            box-shadow: 0 0 8px var(--buy);
            animation: pulse 2.2s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50%       { opacity: 0.3; transform: scale(0.7); }
        }

        /* ─────────────────────────────────────────
           LAYOUT
        ───────────────────────────────────────── */
        .layout {
            position: relative;
            z-index: 1;
            display: grid;
            grid-template-columns: 288px 1fr;
            height: calc(100vh - 54px);
        }

        /* ─────────────────────────────────────────
           SIDEBAR
        ───────────────────────────────────────── */
        .sidebar {
            background: rgba(6,14,24,0.80);
            border-right: 1px solid var(--border-hi);
            padding: 28px 22px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 22px;
            animation: slide-left 0.5s cubic-bezier(0.22,1,0.36,1) both;
        }
        @keyframes slide-left {
            from { transform: translateX(-24px); opacity: 0; }
            to   { transform: translateX(0);     opacity: 1; }
        }

        .sb-section-label {
            font-family: var(--font-data);
            font-size: 12px;
            font-weight: 500;
            letter-spacing: 0.18em;
            color: var(--text-dim);
            text-transform: uppercase;
            padding-bottom: 14px;
            border-bottom: 1px solid var(--border);
        }

        .field-stack { display: flex; flex-direction: column; gap: 18px; }

        .field { display: flex; flex-direction: column; gap: 7px; }

        .field-label {
            display: flex;
            align-items: center;
            gap: 7px;
            font-family: var(--font-data);
            font-size: 11px;
            font-weight: 500;
            letter-spacing: 0.16em;
            color: var(--text-muted);
            text-transform: uppercase;
        }
        .field-label::before {
            content: '//';
            color: var(--text-dim);
            font-size: 11px;
            letter-spacing: 0;
        }

        .field-hint {
            font-family: var(--font-data);
            font-size: 11px;
            color: var(--text-dim);
            letter-spacing: 0.05em;
            margin-top: 2px;
        }

        /* two-column row */
        .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }

        /* sub-label inside two-col */
        .sub-label {
            font-family: var(--font-data);
            font-size: 11px;
            color: var(--text-dim);
            letter-spacing: 0.1em;
            margin-top: 5px;
        }

        input[type="text"],
        input[type="date"],
        input[type="number"] {
            width: 100%;
            padding: 10px 12px;
            background: var(--panel);
            border: 1px solid var(--border-hi);
            border-radius: var(--r);
            color: var(--text);
            font-family: var(--font-data);
            font-size: 15px;
            font-weight: 500;
            outline: none;
            transition: border-color 0.18s, box-shadow 0.18s, background 0.18s;
            -webkit-appearance: none;
        }
        input::placeholder { color: var(--text-dim); }
        input:focus {
            border-color: var(--accent);
            background: var(--elevated);
            box-shadow: 0 0 0 3px var(--accent-faint);
        }
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(0.35) sepia(1) saturate(0.5);
            cursor: pointer;
        }

        .ticker-wrap {
            position: relative;
        }
        .ticker-prefix {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            font-family: var(--font-data);
            font-size: 15px;
            color: var(--accent);
            pointer-events: none;
            font-weight: 500;
        }
        #ticker { padding-left: 28px; text-transform: uppercase; letter-spacing: 0.06em; }

        .divider {
            height: 1px;
            background: linear-gradient(90deg, var(--border-hi), transparent);
        }

        .run-btn {
            position: relative;
            width: 100%;
            padding: 14px;
            background: var(--accent);
            color: var(--void);
            border: none;
            border-radius: var(--r);
            font-family: var(--font-ui);
            font-size: 14px;
            font-weight: 800;
            letter-spacing: 0.18em;
            text-transform: uppercase;
            cursor: pointer;
            overflow: hidden;
            transition: box-shadow 0.2s, transform 0.15s;
        }
        .run-btn::before {
            content: '';
            position: absolute;
            top: 0; left: -100%;
            width: 60%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.25), transparent);
            transition: left 0.5s;
        }
        .run-btn:hover::before { left: 150%; }
        .run-btn:hover {
            box-shadow: 0 0 28px var(--buy-glow), 0 4px 16px rgba(0,0,0,0.5);
            transform: translateY(-1px);
        }
        .run-btn:active { transform: translateY(0); }
        .run-btn:disabled {
            background: var(--elevated);
            color: var(--text-muted);
            box-shadow: none;
            transform: none;
            cursor: not-allowed;
        }
        .run-btn:disabled::before { display: none; }

        /* ─────────────────────────────────────────
           MAIN AREA
        ───────────────────────────────────────── */
        .main {
            display: flex;
            flex-direction: column;
            overflow: hidden;
            animation: fade-in 0.5s ease 0.1s both;
        }

        @keyframes fade-in {
            from { opacity: 0; }
            to   { opacity: 1; }
        }

        /* error bar */
        .error-bar {
            display: none;
            align-items: center;
            gap: 10px;
            padding: 10px 24px;
            background: rgba(255,63,92,0.07);
            border-bottom: 1px solid rgba(255,63,92,0.2);
            font-family: var(--font-data);
            font-size: 13px;
            color: var(--sell);
            letter-spacing: 0.04em;
            flex-shrink: 0;
        }
        .error-bar.active {
            display: flex;
            animation: slide-down 0.25s ease;
        }
        @keyframes slide-down {
            from { transform: translateY(-100%); opacity: 0; }
            to   { transform: translateY(0);     opacity: 1; }
        }
        .err-icon { opacity: 0.7; font-style: normal; }

        /* ── chart section ── */
        .chart-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px 24px 16px;
            border-bottom: 1px solid var(--border);
            min-height: 0;
        }

        .section-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 14px;
            flex-shrink: 0;
        }

        .section-tag {
            font-family: var(--font-data);
            font-size: 11px;
            font-weight: 500;
            letter-spacing: 0.18em;
            color: var(--text-dim);
            text-transform: uppercase;
        }

        .legend {
            display: none;
            align-items: center;
            gap: 18px;
            flex-wrap: wrap;
        }
        .legend.visible { display: flex; }

        .leg-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-family: var(--font-data);
            font-size: 11px;
            color: var(--text-muted);
            letter-spacing: 0.06em;
        }
        .leg-line { width: 14px; height: 2px; border-radius: 1px; }
        .leg-dot  { width: 7px;  height: 7px; border-radius: 50%; }

        .chart-wrap {
            flex: 1;
            position: relative;
            min-height: 0;
        }

        canvas#priceChart {
            position: absolute;
            inset: 0;
            width: 100% !important;
            height: 100% !important;
            display: none;
        }

        /* shared overlay */
        .overlay {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .empty-glyph {
            font-family: var(--font-data);
            font-size: 52px;
            color: var(--text-dim);
            line-height: 1;
            user-select: none;
        }
        .empty-msg {
            font-family: var(--font-data);
            font-size: 13px;
            color: var(--text-dim);
            letter-spacing: 0.08em;
            text-align: center;
            line-height: 1.8;
        }

        .spinner-wrap { display: flex; flex-direction: column; align-items: center; gap: 14px; }
        .spinner-dots {
            font-family: var(--font-data);
            font-size: 28px;
            letter-spacing: 0.5em;
            color: var(--accent);
            animation: flicker 1.4s steps(3, end) infinite;
        }
        @keyframes flicker {
            0%   { opacity: 0.15; }
            50%  { opacity: 1; }
            100% { opacity: 0.15; }
        }
        .spinner-label {
            font-family: var(--font-data);
            font-size: 12px;
            color: var(--text-muted);
            letter-spacing: 0.2em;
            text-transform: uppercase;
        }

        /* ── metrics section ── */
        .metrics-section {
            padding: 16px 24px 20px;
            flex-shrink: 0;
        }

        .metrics-grid {
            display: none;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
            margin-top: 14px;
        }

        .m-card {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: var(--r);
            padding: 13px 14px 12px;
            cursor: default;
            transition: border-color 0.18s, transform 0.18s;
        }
        .m-card:hover {
            border-color: var(--border-hi);
            transform: translateY(-2px);
        }
        .m-card.pos { border-top: 2px solid var(--buy); }
        .m-card.neg { border-top: 2px solid var(--sell); }
        .m-card.neu { border-top: 2px solid var(--border-hi); }

        .m-label {
            font-family: var(--font-data);
            font-size: 11px;
            font-weight: 500;
            letter-spacing: 0.14em;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: 10px;
        }
        .m-value {
            font-family: var(--font-data);
            font-size: 22px;
            font-weight: 700;
            line-height: 1;
            letter-spacing: -0.02em;
            color: var(--text);
        }
        .m-card.pos .m-value { color: var(--buy); }
        .m-card.neg .m-value { color: var(--sell); }

        .metrics-placeholder {
            font-family: var(--font-data);
            font-size: 12px;
            color: var(--text-dim);
            letter-spacing: 0.12em;
            padding: 14px 0 4px;
        }

        .metrics-loading {
            display: none;
            font-family: var(--font-data);
            font-size: 12px;
            color: var(--text-dim);
            letter-spacing: 0.2em;
            text-transform: uppercase;
            padding: 14px 0 4px;
            animation: flicker 1.4s steps(3, end) infinite;
        }

        /* ─────────────────────────────────────────
           RESPONSIVE
        ───────────────────────────────────────── */
        @media (max-width: 1100px) {
            .metrics-grid { grid-template-columns: repeat(3, 1fr); }
        }
        @media (max-width: 860px) {
            body, html { overflow: auto; }
            .layout {
                grid-template-columns: 1fr;
                height: auto;
            }
            .sidebar { border-right: none; border-bottom: 1px solid var(--border-hi); }
            .main    { min-height: 80vh; }
            .chart-section { min-height: 400px; }
            .metrics-grid { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>

    <!-- ═══ HEADER ═══ -->
    <header class="hdr">
        <div class="hdr-left">
            <span class="logo">STRATAGEM</span>
            <div class="hdr-div"></div>
            <span class="hdr-sub">MA Golden Cross Backtester</span>
        </div>
        <div class="hdr-right">
            <span class="live-dot"></span>
            SYS:LIVE &nbsp;·&nbsp; :8000
        </div>
    </header>

    <div class="layout">

        <!-- ═══ SIDEBAR ═══ -->
        <aside class="sidebar">

            <span class="sb-section-label">// Parameters</span>

            <form id="backtestForm" class="field-stack">

                <div class="field">
                    <label class="field-label" for="ticker">Ticker</label>
                    <div class="ticker-wrap">
                        <span class="ticker-prefix">$</span>
                        <input type="text" id="ticker" placeholder="AAPL" autocomplete="off" spellcheck="false" required>
                    </div>
                    <span class="field-hint">NYSE / NASDAQ / ETF symbol</span>
                </div>

                <div class="field">
                    <label class="field-label">Date Range</label>
                    <div class="two-col">
                        <div>
                            <input type="date" id="startDate" required>
                            <div class="sub-label">START</div>
                        </div>
                        <div>
                            <input type="date" id="endDate" required>
                            <div class="sub-label">END</div>
                        </div>
                    </div>
                </div>

                <div class="field">
                    <label class="field-label">MA Periods</label>
                    <div class="two-col">
                        <div>
                            <input type="number" id="shortPeriod" value="50" min="1" required>
                            <div class="sub-label">SHORT</div>
                        </div>
                        <div>
                            <input type="number" id="longPeriod" value="200" min="1" required>
                            <div class="sub-label">LONG</div>
                        </div>
                    </div>
                </div>

                <div class="field">
                    <label class="field-label" for="initialCapital">Capital</label>
                    <input type="number" id="initialCapital" value="100000" min="1" step="1" required>
                    <span class="field-hint">Initial USD allocation</span>
                </div>

                <div class="divider"></div>

                <button type="submit" id="submitBtn" class="run-btn">Execute Backtest</button>

            </form>

        </aside>

        <!-- ═══ MAIN ═══ -->
        <main class="main">

            <!-- error bar -->
            <div class="error-bar" id="errorMessage">
                <em class="err-icon">✗</em>
                <span id="errorText"></span>
            </div>

            <!-- chart -->
            <section class="chart-section">

                <div class="section-bar">
                    <span class="section-tag">// Price · MA Crossovers</span>
                    <div class="legend" id="legendContainer">
                        <div class="leg-item">
                            <div class="leg-line" style="background:rgba(100,160,220,0.9);"></div>
                            Price
                        </div>
                        <div class="leg-item">
                            <div class="leg-line" style="background:#ffb83f;"></div>
                            Short MA
                        </div>
                        <div class="leg-item">
                            <div class="leg-line" style="background:#7c5cbf;"></div>
                            Long MA
                        </div>
                        <div class="leg-item">
                            <div class="leg-dot" style="background:var(--buy);"></div>
                            Golden Cross
                        </div>
                        <div class="leg-item">
                            <div class="leg-dot" style="background:var(--sell);"></div>
                            Death Cross
                        </div>
                    </div>
                </div>

                <div class="chart-wrap">
                    <div class="overlay" id="chartEmpty">
                        <span class="empty-glyph">⟋</span>
                        <span class="empty-msg">
                            Enter parameters above<br>and execute to render the chart
                        </span>
                    </div>
                    <div class="overlay" id="chartLoading" style="display:none;">
                        <div class="spinner-wrap">
                            <span class="spinner-dots">···</span>
                            <span class="spinner-label">Fetching market data</span>
                        </div>
                    </div>
                    <canvas id="priceChart"></canvas>
                </div>

            </section>

            <!-- metrics -->
            <section class="metrics-section">
                <div class="section-bar">
                    <span class="section-tag">// Performance Metrics</span>
                </div>
                <div class="metrics-placeholder" id="resultsEmpty">Awaiting execution —</div>
                <div class="metrics-loading" id="resultsLoading">Calculating ···</div>
                <div class="metrics-grid" id="resultsGrid"></div>
            </section>

        </main>
    </div>

    <script>
        let chart = null;
        const API_BASE_URL = 'http://localhost:8000';

        /* ── date defaults ── */
        function initializeDates() {
            const now   = new Date();
            const start = new Date();
            start.setFullYear(now.getFullYear() - 3);
            document.getElementById('endDate').valueAsDate   = now;
            document.getElementById('startDate').valueAsDate = start;
        }

        /* ── formatters ── */
        function fmtCurrency(v) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency', currency: 'USD', maximumFractionDigits: 0
            }).format(v);
        }
        function fmtPct(v) {
            return `${v >= 0 ? '+' : ''}${v.toFixed(2)}%`;
        }
        function fmtFixed(v, d = 3) {
            return v.toFixed(d);
        }

        /* ── count-up animation ── */
        function countUp(el, target, duration, fmt) {
            const start  = performance.now();
            const sign   = target < 0 ? -1 : 1;
            const abs    = Math.abs(target);
            function step(now) {
                const t = Math.min((now - start) / duration, 1);
                const e = 1 - Math.pow(1 - t, 3); // ease-out-cubic
                const v = abs * e * sign;
                el.textContent = fmt(v);
                if (t < 1) requestAnimationFrame(step);
                else       el.textContent = fmt(target);
            }
            requestAnimationFrame(step);
        }

        /* ── error ── */
        function showError(msg) {
            const bar = document.getElementById('errorMessage');
            document.getElementById('errorText').textContent = msg;
            bar.classList.add('active');
            setTimeout(() => bar.classList.remove('active'), 6000);
        }

        /* ── loading state ── */
        function setLoading(on) {
            const btn = document.getElementById('submitBtn');
            btn.disabled    = on;
            btn.textContent = on ? 'Running…' : 'Execute Backtest';

            document.getElementById('chartEmpty').style.display   = on ? 'none'  : 'flex';
            document.getElementById('chartLoading').style.display = on ? 'flex'  : 'none';
            document.getElementById('resultsEmpty').style.display   = 'none';
            document.getElementById('resultsLoading').style.display = on ? 'block' : 'none';
        }

        /* ── restore empty on error ── */
        function restoreEmpty() {
            document.getElementById('chartEmpty').style.display   = 'flex';
            document.getElementById('chartLoading').style.display = 'none';
            document.getElementById('resultsEmpty').style.display   = 'block';
            document.getElementById('resultsLoading').style.display = 'none';
        }

        /* ── chart ── */
        function buildChart(data, params) {
            const canvas = document.getElementById('priceChart');
            if (chart) chart.destroy();

            const buys  = (data.signals || []).filter(s => s.type === 'golden_cross');
            const sells = (data.signals || []).filter(s => s.type === 'death_cross');

            const datasets = [
                {
                    label: 'Price',
                    data: data.dates.map((d, i) => ({ x: d, y: data.prices[i] || null })),
                    borderColor: 'rgba(100,160,220,0.9)',
                    backgroundColor: 'rgba(100,160,220,0.04)',
                    borderWidth: 1.5,
                    pointRadius: 0,
                    tension: 0.1,
                    fill: true
                },
                {
                    label: `Short MA (${params.short_period})`,
                    data: data.dates.map((d, i) => ({ x: d, y: data.short_ma[i] || null })),
                    borderColor: 'rgba(255,184,63,0.9)',
                    borderWidth: 1.5,
                    pointRadius: 0,
                    tension: 0.1,
                    fill: false
                },
                {
                    label: `Long MA (${params.long_period})`,
                    data: data.dates.map((d, i) => ({ x: d, y: data.long_ma[i] || null })),
                    borderColor: 'rgba(124,92,191,0.9)',
                    borderWidth: 1.5,
                    pointRadius: 0,
                    tension: 0.1,
                    fill: false
                }
            ];

            if (buys.length)
                datasets.push({
                    label: 'Golden Cross',
                    data: buys.map(s => ({ x: s.date, y: s.price })),
                    borderColor: '#05f5b0', backgroundColor: '#05f5b0',
                    pointRadius: 7, pointStyle: 'triangle',
                    showLine: false, pointRotation: 0
                });

            if (sells.length)
                datasets.push({
                    label: 'Death Cross',
                    data: sells.map(s => ({ x: s.date, y: s.price })),
                    borderColor: '#ff3f5c', backgroundColor: '#ff3f5c',
                    pointRadius: 7, pointStyle: 'triangle',
                    showLine: false, pointRotation: 180
                });

            chart = new Chart(canvas.getContext('2d'), {
                type: 'line',
                data: { datasets },
                options: {
                    responsive: false,
                    maintainAspectRatio: false,
                    animation: { duration: 900, easing: 'easeOutQuart' },
                    interaction: { intersect: false, mode: 'index' },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(9,21,37,0.96)',
                            borderColor: 'rgba(24,51,72,0.8)',
                            borderWidth: 1,
                            titleColor: '#3f6080',
                            bodyColor: '#b8d0e4',
                            titleFont: { family: 'JetBrains Mono', size: 12 },
                            bodyFont:  { family: 'JetBrains Mono', size: 14 },
                            padding: 14,
                            callbacks: {
                                label: ctx => {
                                    const v = ctx.parsed.y;
                                    if (v == null) return null;
                                    return `${ctx.dataset.label}: ${fmtCurrency(v)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: { unit: 'month', displayFormats: { month: 'MMM yy' } },
                            grid:   { color: 'rgba(15,32,53,0.7)', lineWidth: 1 },
                            ticks:  { color: '#3a5570', font: { family: 'JetBrains Mono', size: 11 } },
                            border: { color: 'transparent' }
                        },
                        y: {
                            grid:   { color: 'rgba(15,32,53,0.7)', lineWidth: 1 },
                            ticks:  {
                                color: '#3a5570',
                                font: { family: 'JetBrains Mono', size: 11 },
                                callback: v => '$' + v.toFixed(0)
                            },
                            border: { color: 'transparent' }
                        }
                    }
                }
            });

            /* manually size canvas to fill wrapper */
            const wrap = canvas.parentElement;
            canvas.width  = wrap.clientWidth;
            canvas.height = wrap.clientHeight;
            chart.resize();

            canvas.style.display = 'block';
            document.getElementById('chartEmpty').style.display   = 'none';
            document.getElementById('chartLoading').style.display = 'none';
            document.getElementById('legendContainer').classList.add('visible');
        }

        /* ── metrics ── */
        function buildMetrics(m) {
            const grid = document.getElementById('resultsGrid');
            grid.innerHTML = '';

            const cards = [
                {
                    label: 'Total Return',
                    value: m.total_return_pct,
                    render: v => countUp(valEl, v, 900, fmtPct),
                    cls: m.total_return_pct >= 0 ? 'pos' : 'neg'
                },
                {
                    label: 'Final Value',
                    value: m.final_portfolio_value,
                    render: v => countUp(valEl, v, 900, fmtCurrency),
                    cls: m.final_portfolio_value >= m.initial_capital ? 'pos' : 'neg'
                },
                {
                    label: 'Sharpe Ratio',
                    value: m.sharpe_ratio,
                    render: v => countUp(valEl, v, 900, x => fmtFixed(x, 3)),
                    cls: m.sharpe_ratio > 1 ? 'pos' : m.sharpe_ratio > 0 ? 'neu' : 'neg'
                },
                {
                    label: 'Win Rate',
                    value: m.win_rate_pct,
                    render: v => countUp(valEl, v, 900, fmtPct),
                    cls: m.win_rate_pct >= 50 ? 'pos' : 'neg'
                },
                {
                    label: 'Max Drawdown',
                    value: m.max_drawdown_pct,
                    render: v => countUp(valEl, v, 900, fmtPct),
                    cls: m.max_drawdown_pct >= -10 ? 'neu' : 'neg'
                },
                {
                    label: 'Trades',
                    value: m.num_trades,
                    render: () => { valEl.textContent = m.num_trades; },
                    cls: 'neu'
                }
            ];

            cards.forEach((c, i) => {
                const card = document.createElement('div');
                card.className = `m-card ${c.cls}`;
                card.style.cssText = `animation: fade-up 0.4s ease ${i * 55}ms both`;

                const lbl = document.createElement('div');
                lbl.className = 'm-label';
                lbl.textContent = c.label;

                var valEl = document.createElement('div');
                valEl.className = 'm-value';
                valEl.textContent = '—';

                card.appendChild(lbl);
                card.appendChild(valEl);
                grid.appendChild(card);

                // trigger count-up after card is in DOM
                requestAnimationFrame(() => c.render(c.value));
            });

            grid.style.display = 'grid';
            document.getElementById('resultsEmpty').style.display   = 'none';
            document.getElementById('resultsLoading').style.display = 'none';
        }

        /* ── fade-up keyframe (injected once) ── */
        document.head.insertAdjacentHTML('beforeend',
            `<style>@keyframes fade-up {
                from { transform: translateY(12px); opacity: 0; }
                to   { transform: translateY(0);    opacity: 1; }
            }</style>`
        );

        /* ── form submit ── */
        async function handleSubmit(e) {
            e.preventDefault();

            const body = {
                ticker:          document.getElementById('ticker').value.trim().toUpperCase(),
                start_date:      document.getElementById('startDate').value,
                end_date:        document.getElementById('endDate').value,
                short_period:    parseInt(document.getElementById('shortPeriod').value),
                long_period:     parseInt(document.getElementById('longPeriod').value),
                initial_capital: parseFloat(document.getElementById('initialCapital').value)
            };

            if (body.short_period >= body.long_period) {
                showError('Short MA period must be less than Long MA period'); return;
            }
            if (new Date(body.start_date) >= new Date(body.end_date)) {
                showError('Start date must be before end date'); return;
            }

            setLoading(true);

            try {
                const res = await fetch(`${API_BASE_URL}/api/backtest`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                if (!res.ok) {
                    const err = await res.json();
                    throw new Error(err.detail || 'Backtest failed');
                }

                const { data } = await res.json();
                buildChart(data.chart_data, data.request_params);
                buildMetrics(data.performance_metrics);

            } catch (err) {
                console.error(err);
                showError(err.message || 'An error occurred');
                restoreEmpty();
            } finally {
                const btn = document.getElementById('submitBtn');
                btn.disabled    = false;
                btn.textContent = 'Execute Backtest';
            }
        }

        /* ── resize handler ── */
        window.addEventListener('resize', () => {
            if (!chart) return;
            const canvas = document.getElementById('priceChart');
            const wrap   = canvas.parentElement;
            canvas.width  = wrap.clientWidth;
            canvas.height = wrap.clientHeight;
            chart.resize();
        });

        /* ── init ── */
        document.addEventListener('DOMContentLoaded', () => {
            initializeDates();
            document.getElementById('backtestForm').addEventListener('submit', handleSubmit);
        });
    </script>
</body>
</html>
